<!DOCTYPE html>

<html lang="ru">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">

    <title>CartoPro Studio Ultra - –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>

    <style>

        :root {

            --bg-main: #0c0c0e;

            --bg-sidebar: #16161a;

            --bg-panel: #1f1f27;

            --accent: #3b82f6;

            --accent-glow: rgba(59, 130, 246, 0.4);

            --text-main: #f8fafc;

            --text-dim: #94a3b8;

            --border: #2e2e38;

            --danger: #ef4444;

            --success: #10b981;

        }



        * { 

            box-sizing: border-box; 

            margin: 0; 

            padding: 0; 

            -webkit-user-select: none; 

            -webkit-touch-callout: none; 

        }



        html, body { 

            width: 100%; 

            height: 100%; 

            overflow: hidden; 

            font-family: 'Inter', -apple-system, system-ui, sans-serif; 

            background: var(--bg-main); 

            color: var(--text-main); 

        }



        body { display: flex; flex-direction: column; }



        /* HEADER */

        header {

            background: var(--bg-sidebar); 

            border-bottom: 1px solid var(--border);

            display: flex; 

            align-items: center; 

            justify-content: space-between;

            padding: 0 16px;

            height: 60px;

            flex-shrink: 0;

            z-index: 1000;

        }



        .logo-container { display: flex; align-items: center; gap: 8px; }

        .logo-icon { width: 24px; height: 24px; background: var(--accent); border-radius: 6px; }

        .logo-text { font-weight: 800; font-size: 18px; letter-spacing: -0.5px; }



        .header-controls { display: flex; gap: 8px; }

        .btn-icon {

            width: 36px; height: 36px; border-radius: 8px; border: 1px solid var(--border);

            background: var(--bg-panel); color: var(--text-main); cursor: pointer;

            display: flex; align-items: center; justify-content: center; transition: 0.2s;

        }

        .btn-icon:active { transform: scale(0.9); background: var(--border); }

        .btn-save { background: var(--accent); border: none; padding: 0 12px; width: auto; font-weight: 600; font-size: 13px; gap: 6px; }



        /* CANVAS AREA */

        .viewport {

            flex: 1; position: relative; overflow: hidden;

            display: flex; align-items: center; justify-content: center;

            background: #111;

            background-image: 

                radial-gradient(circle at 2px 2px, var(--border) 1px, transparent 0);

            background-size: 32px 32px;

        }



        #canvas-container {

            position: relative; box-shadow: 0 30px 60px rgba(0,0,0,0.5);

            transition: transform 0.1s ease-out; touch-action: none;

            cursor: grab;

        }

        #canvas-container.dragging { cursor: grabbing; }



        canvas { display: block; background: #fff; cursor: crosshair; }



        /* SETTINGS MENU */

        .side-settings {

            position: fixed; top: 70px; right: 10px; bottom: 90px; width: 280px;

            background: var(--bg-sidebar); border: 1px solid var(--border);

            border-radius: 16px; z-index: 900; display: none; flex-direction: column;

            box-shadow: -10px 0 30px rgba(0,0,0,0.3); overflow: hidden;

        }

        .side-settings.active { display: flex; }



        .settings-header { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }

        .settings-content { flex: 1; overflow-y: auto; padding: 16px; }



        /* TOOLS PANEL */

        .bottom-nav {

            height: 80px; background: var(--bg-sidebar); border-top: 1px solid var(--border);

            display: flex; align-items: center; justify-content: flex-start; gap: 12px;

            padding: 0 16px; z-index: 1000; overflow-x: auto; overflow-y: hidden;

        }

        .bottom-nav::-webkit-scrollbar {

            height: 4px;

        }

        .bottom-nav::-webkit-scrollbar-track {

            background: var(--bg-main);

        }

        .bottom-nav::-webkit-scrollbar-thumb {

            background: var(--border);

            border-radius: 2px;

        }

        .bottom-nav::-webkit-scrollbar-thumb:hover {

            background: var(--accent);

        }



        .tool-card {

            display: flex; flex-direction: column; align-items: center; gap: 4px;

            color: var(--text-dim); cursor: pointer; transition: 0.2s; min-width: 55px;

        }

        .tool-card.active { color: var(--accent); }

        .tool-circle {

            width: 44px; height: 44px; border-radius: 12px;

            display: flex; align-items: center; justify-content: center;

            background: var(--bg-panel); border: 1px solid var(--border);

        }

        .tool-card.active .tool-circle { background: var(--accent); border-color: var(--accent); color: white; box-shadow: 0 0 15px var(--accent-glow); }

        .tool-label { font-size: 10px; font-weight: 600; text-transform: uppercase; }



        /* WIDGETS */

        .control-group { margin-bottom: 20px; }

        .group-label { font-size: 11px; font-weight: 800; color: var(--text-dim); text-transform: uppercase; margin-bottom: 10px; display: block; }

        

        .size-slider-wrap { display: flex; align-items: center; gap: 10px; }

        input[type="range"] { flex: 1; accent-color: var(--accent); }



        .color-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }

        .color-dot { aspect-ratio: 1; border-radius: 8px; border: 2px solid transparent; cursor: pointer; }

        .color-dot.active { border-color: white; transform: scale(1.1); }



        /* SYMBOL GRID */

        .symbol-grid {

            display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;

            background: var(--bg-panel); padding: 10px; border-radius: 12px;

        }

        .sym-item {

            aspect-ratio: 1; display: flex; align-items: center; justify-content: center;

            font-size: 20px; background: var(--bg-main); border-radius: 8px;

            cursor: pointer; border: 1px solid var(--border);

        }

        .sym-item:active { background: var(--accent); }

        .sym-item.active { border-color: var(--accent); color: var(--accent); background: rgba(59, 130, 246, 0.1); }



        /* CHART SECTION ITEM */

        .chart-section-item {

            display: grid; grid-template-columns: 1fr 60px 40px 30px; gap: 6px;

            background: var(--bg-main); padding: 8px; border-radius: 6px; align-items: center;

            border: 1px solid var(--border);

        }

        .chart-section-item input {

            background: transparent; border: 1px solid var(--border); 

            color: white; padding: 4px; border-radius: 4px; font-size: 11px;

        }

        .chart-btn-small {

            width: 28px; height: 28px; border-radius: 4px; border: 1px solid var(--border);

            background: transparent; color: var(--text-main); cursor: pointer; font-size: 12px;

            display: flex; align-items: center; justify-content: center; transition: 0.2s;

        }

        .chart-btn-small:active { background: var(--accent); }

        .chart-btn-remove { color: var(--danger); }



        /* MODALS */

        .modal {

            position: fixed; inset: 0; background: rgba(0,0,0,0.85);

            display: none; align-items: center; justify-content: center; z-index: 2000; padding: 20px;

        }

        .modal.active { display: flex; }

        .modal-body { 

            background: var(--bg-sidebar); width: 100%; max-width: 340px; 

            border-radius: 20px; padding: 24px; border: 1px solid var(--border);

        }



        .icon-svg { width: 22px; height: 22px; fill: none; stroke: currentColor; stroke-width: 2; }

        

        .legend-input { 

            background: transparent; border: 1px solid var(--border); 

            color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px;

        }

    </style>

</head>

<body>



<header>

    <div class="logo-container">

        <div class="logo-icon"></div>

        <div class="logo-text">CARTOPRO <span style="color:var(--text-dim); font-weight:400">ULTRA</span></div>

    </div>

    <div class="header-controls">

        <button class="btn-icon" onclick="undo()" title="–ù–∞–∑–∞–¥">‚Ü∫</button>

        <button class="btn-icon" onclick="redo()" title="–í–ø–µ—Ä–µ–¥">‚Üª</button>

        <button class="btn-icon btn-save" onclick="exportCanvas()">

            <span>–°–û–•–†–ê–ù–ò–¢–¨</span>

        </button>

    </div>

</header>



<div class="viewport">

    <div id="canvas-container">

        <canvas id="mainCanvas"></canvas>

    </div>

</div>



<div class="side-settings" id="sidePanel">

    <div class="settings-header">

        <span id="panelTitle" style="font-weight:700">–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã</span>

        <button class="btn-icon" onclick="togglePanel()" style="border:none; background:transparent">‚úï</button>

    </div>

    <div class="settings-content">

        

        <div class="control-group">

            <label class="group-label">–†–∞–∑–º–µ—Ä / –¢–æ–ª—â–∏–Ω–∞: <span id="sizeVal">24</span>px</label>

            <div class="size-slider-wrap">

                <input type="range" id="sizeRange" min="4" max="120" value="24">

            </div>

        </div>



        <div class="control-group">

            <label class="group-label">–ü–∞–ª–∏—Ç—Ä–∞</label>

            <div class="color-grid" id="colorPalette">

                </div>

        </div>



        <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">



        <div id="poiSettings" style="display:none">

            <label class="group-label">–ó–Ω–∞—á–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤ (–∏–∑ –∞—Ç–ª–∞—Å–∞)</label>

            <div class="symbol-grid" id="symbolGrid">

                </div>

        </div>



        <div id="markerSettings" style="display:none">

            <label class="group-label">–¶–≤–µ—Ç –º–∞—Ä–∫–µ—Ä–∞</label>

            <div class="color-grid" id="markerColorPalette">

                </div>

        </div>



        <div id="chartSettings" style="display:none">

            <label class="group-label">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≥—Ä–∞—Ñ–∏–∫–∞</label>

            <div class="control-group">

                <label class="group-label">–¢–∏–ø –≥—Ä–∞—Ñ–∏–∫–∞</label>

                <select id="chartType" style="width:100%; padding:8px; background:var(--bg-panel); color:var(--text-main); border:1px solid var(--border); border-radius:6px;">

                    <option value="line">–õ–∏–Ω–µ–π–Ω—ã–π</option>

                    <option value="bar">–°—Ç–æ–ª–±—Ü—ã</option>

                    <option value="pie">–ö—Ä—É–≥–æ–≤–∞—è</option>

                </select>

            </div>

            <label class="group-label" style="margin-top:15px;">–†–∞–∑–¥–µ–ª—ã –≥—Ä–∞—Ñ–∏–∫–∞</label>

            <div id="chartSections" style="display:flex; flex-direction:column; gap:8px; max-height:180px; overflow-y:auto; background:var(--bg-panel); padding:8px; border-radius:8px; border: 1px solid var(--border);"></div>

            <button onclick="addChartSection()" class="btn-save" style="width:100%; margin-top:10px; height:35px; background:var(--bg-panel); border:1px solid var(--border); color: var(--text-main);">+ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞–∑–¥–µ–ª</button>

            <button onclick="drawChartToCanvas()" class="btn-save" style="width:100%; margin-top:8px; height:40px;">–ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫</button>

            <p style="font-size:11px; color:var(--text-dim); margin-top:10px;">üí° –ì—Ä–∞—Ñ–∏–∫ –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞—Ç—å –º—ã—à–∫–æ–π</p>

        </div>

    </div>

</div>



<nav class="bottom-nav">

    <div class="tool-card active" onclick="setTool('brush', this)">

        <div class="tool-circle"><svg class="icon-svg"><path d="M12 19l7-7 3 3-7 7-3-3zM18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/></svg></div>

        <div class="tool-label">–ö–∏—Å—Ç—å</div>

    </div>

    <div class="tool-card" onclick="setTool('poi', this)">

        <div class="tool-circle"><svg class="icon-svg"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg></div>

        <div class="tool-label">–°–∏–º–≤–æ–ª</div>

    </div>

    <div class="tool-card" onclick="setTool('text', this)">

        <div class="tool-circle"><svg class="icon-svg"><path d="M4 7V4h16v3M12 4v16"/></svg></div>

        <div class="tool-label">–¢–µ–∫—Å—Ç</div>

    </div>

    <div class="tool-card" onclick="setTool('marker', this)">

        <div class="tool-circle"><svg class="icon-svg"><path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/><circle cx="12" cy="11" r="2" fill="white"/></svg></div>

        <div class="tool-label">–ú–∞—Ä–∫–µ—Ä</div>

    </div>

    <div class="tool-card" onclick="setTool('chart', this)">

        <div class="tool-circle"><svg class="icon-svg"><path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/></svg></div>

        <div class="tool-label">–ì—Ä–∞—Ñ–∏–∫</div>

    </div>

    <div class="tool-card" onclick="setTool('eraser', this)">

        <div class="tool-circle"><svg class="icon-svg"><path d="m7 21-4.3-4.3c-1-1-1-2.5 0-3.4l9.6-9.6c1-1 2.5-1 3.4 0l5.6 5.6c1 1 1 2.5 0 3.4L13 21H7z"/></svg></div>

        <div class="tool-label">–õ–∞—Å—Ç–∏–∫</div>

    </div>

    <div class="tool-card" onclick="setTool('image', this)">

        <div class="tool-circle"><svg class="icon-svg"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z"/><circle cx="8.5" cy="9.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg></div>

        <div class="tool-label">–ö–∞—Ä—Ç–∏–Ω–∞</div>

    </div>

    <div class="tool-card">

        <div style="display:flex; gap:6px; align-items:center;">

            <button class="btn-icon" onclick="zoomIn()" title="–ü—Ä–∏–±–ª–∏–∑–∏—Ç—å" style="width:40px; height:40px;">üîç+</button>

            <button class="btn-icon" onclick="zoomOut()" title="–û—Ç–¥–∞–ª–∏—Ç—å" style="width:40px; height:40px;">üîç‚àí</button>

            <button class="btn-icon" onclick="zoomReset()" title="–°–±—Ä–æ—Å" style="width:40px; height:40px; font-size:12px;">1:1</button>

        </div>

        <div class="tool-label" style="margin-top:2px;">–ó—É–º</div>

    </div>

    <div class="tool-card" onclick="togglePanel()">

        <div class="tool-circle" style="background:var(--border)">‚öô</div>

        <div class="tool-label">–û–ø—Ü–∏–∏</div>

    </div>

</nav>



<div class="modal" id="textModal">

    <div class="modal-body">

        <h3 style="margin-bottom:15px">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç</h3>

        <input type="text" id="mapTextInput" class="legend-input" style="width:100%; height:45px; font-size:16px;" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞...">

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">

            <button class="btn-save" style="background:var(--border)" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>

            <button class="btn-save" onclick="confirmText()">–î–æ–±–∞–≤–∏—Ç—å</button>

        </div>

    </div>

</div>



<div class="modal" id="markerModal">

    <div class="modal-body">

        <h3 style="margin-bottom:15px">–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞—Ä–∫–µ—Ä–∞</h3>

        <input type="text" id="markerInput" class="legend-input" style="width:100%; height:45px; font-size:16px;" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞...">

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">

            <button class="btn-save" style="background:var(--border)" onclick="closeMarkerModal()">–û—Ç–º–µ–Ω–∞</button>

            <button class="btn-save" onclick="confirmMarker()">–î–æ–±–∞–≤–∏—Ç—å</button>

        </div>

    </div>

</div>



<input type="file" id="imageInput" accept="image/*" style="display:none;">



<script>

    /**

     * CARTOPRO ULTRA ENGINE v2

     * –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–æ–π –≥—Ä–∞—Ñ–∏–∫–æ–≤

     */



    const canvas = document.getElementById('mainCanvas');

    const ctx = canvas.getContext('2d', { alpha: false });

    const container = document.getElementById('canvas-container');

    const imageInput = document.getElementById('imageInput');



    // –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è

    const state = {

        tool: 'brush',

        color: '#000000',

        markerColor: '#3b82f6',

        size: 24,

        isDrawing: false,

        lastX: 0,

        lastY: 0,

        history: [],

        redoStack: [],

        currentSymbol: '‚ñ≤',

        chartType: 'line',

        textPos: null,

        markerPos: null,

        chartData: [

            { label: '–†–∞–∑–¥–µ–ª 1', value: 30, color: '#3b82f6' },

            { label: '–†–∞–∑–¥–µ–ª 2', value: 60, color: '#ef4444' },

            { label: '–†–∞–∑–¥–µ–ª 3', value: 45, color: '#10b981' },

            { label: '–†–∞–∑–¥–µ–ª 4', value: 75, color: '#f59e0b' }

        ],

        markers: [],

        chartPos: { x: 80, y: 120 },

        chartDragging: false,

        chartDragStart: { x: 0, y: 0 },

        chartVisible: false,

        baseCanvasData: null,

        zoomLevel: 1.0,

        minZoom: 0.3,

        maxZoom: 3.0

    };



    // –í—Å–µ —Å–∏–º–≤–æ–ª—ã

    const SYMBOL_LIBRARY = [

        '‚ñ≤', '‚ñ≥', '‚ñ†', '‚ñ®', '‚ñ∞', '‚óâ', 

        '‚ñ¥', '‚ñæ', '‚ßì', '‚óÜ', '‚ñ¨', '‚ñΩ', '‚ñø', '‚ñº', '‚ò¢', '‚ñ°', '‚¨≠', '‚óá', '‚¨´', '‚¨î',

        '‚óã', '‚óë', '‚óí', '‚ú™', '‚ú∑', '‚úö', '‚ñÆ', '‚ñß', '‚¨í', '‚óç', '‚ñµ', '‚ñ≠', '‚ñ±', '‚óä'

    ];



    const COLORS = [

        '#000000', '#ffffff', '#ef4444', '#f59e0b', '#10b981', 

        '#3b82f6', '#8b5cf6', '#ec4899', '#71717a', '#452c1e'

    ];



    const CHART_COLORS = ['#3b82f6', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899', '#71717a', '#06b6d4'];



    function init() {

        canvas.width = 1400;

        canvas.height = 1000;

        

        ctx.fillStyle = '#ffffff';

        ctx.fillRect(0, 0, canvas.width, canvas.height);



        setupUI();

        saveState();

        

        fitCanvas();

        window.addEventListener('resize', fitCanvas);

    }



    function setupUI() {

        const palette = document.getElementById('colorPalette');

        COLORS.forEach(c => {

            const dot = document.createElement('div');

            dot.className = 'color-dot' + (c === state.color ? ' active' : '');

            dot.style.background = c;

            dot.onclick = () => {

                state.color = c;

                document.querySelectorAll('#colorPalette .color-dot').forEach(d => d.classList.remove('active'));

                dot.classList.add('active');

            };

            palette.appendChild(dot);

        });



        // –ü–∞–ª–∏—Ç—Ä–∞ –º–∞—Ä–∫–µ—Ä–æ–≤

        const markerPalette = document.getElementById('markerColorPalette');

        COLORS.forEach(c => {

            const dot = document.createElement('div');

            dot.className = 'color-dot' + (c === state.markerColor ? ' active' : '');

            dot.style.background = c;

            dot.onclick = () => {

                state.markerColor = c;

                document.querySelectorAll('#markerColorPalette .color-dot').forEach(d => d.classList.remove('active'));

                dot.classList.add('active');

            };

            markerPalette.appendChild(dot);

        });



        const grid = document.getElementById('symbolGrid');

        SYMBOL_LIBRARY.forEach(s => {

            const item = document.createElement('div');

            item.className = 'sym-item' + (s === state.currentSymbol ? ' active' : '');

            item.innerText = s;

            item.onclick = () => {

                state.currentSymbol = s;

                document.querySelectorAll('.sym-item').forEach(i => i.classList.remove('active'));

                item.classList.add('active');

            };

            grid.appendChild(item);

        });



        const slider = document.getElementById('sizeRange');

        slider.oninput = (e) => {

            state.size = parseInt(e.target.value);

            document.getElementById('sizeVal').innerText = state.size;

        };



        const chartSelect = document.getElementById('chartType');

        chartSelect.onchange = (e) => {

            state.chartType = e.target.value;

        };



        refreshChartUI();

    }



    function setTool(toolName, el) {

        state.tool = toolName;

        document.querySelectorAll('.tool-card').forEach(c => c.classList.remove('active'));

        el.classList.add('active');



        document.getElementById('poiSettings').style.display = (toolName === 'poi') ? 'block' : 'none';

        document.getElementById('markerSettings').style.display = (toolName === 'marker') ? 'block' : 'none';

        document.getElementById('chartSettings').style.display = (toolName === 'chart') ? 'block' : 'none';

        

        if(toolName === 'poi' || toolName === 'marker' || toolName === 'chart') togglePanel(true);

        

        if(toolName === 'image') {

            imageInput.click();

        }

    }



    function getMousePos(e) {

        const rect = canvas.getBoundingClientRect();

        const scaleX = canvas.width / rect.width;

        const scaleY = canvas.height / rect.height;

        const clientX = e.touches ? e.touches[0].clientX : e.clientX;

        const clientY = e.touches ? e.touches[0].clientY : e.clientY;

        return {

            x: (clientX - rect.left) * scaleX,

            y: (clientY - rect.top) * scaleY

        };

    }



    canvas.addEventListener('mousedown', startAction);

    canvas.addEventListener('mousemove', moveAction);

    canvas.addEventListener('mouseup', endAction);

    canvas.addEventListener('touchstart', (e) => { e.preventDefault(); startAction(e); });

    canvas.addEventListener('touchmove', (e) => { e.preventDefault(); moveAction(e); });

    canvas.addEventListener('touchend', endAction);



    function startAction(e) {

        const pos = getMousePos(e);

        

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∫–ª–∏–∫–∞–Ω–∏–µ –ø–æ –≥—Ä–∞—Ñ–∏–∫—É –¥–ª—è –µ–≥–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è

        if(state.chartVisible && isMouseOverChart(pos)) {

            state.chartDragging = true;

            state.chartDragStart = { x: pos.x - state.chartPos.x, y: pos.y - state.chartPos.y };

            container.classList.add('dragging');

            return;

        }



        state.isDrawing = true;

        state.lastX = pos.x;

        state.lastY = pos.y;



        if (state.tool === 'poi') {

            drawPOI(pos.x, pos.y);

        } else if (state.tool === 'text') {

            state.textPos = pos;

            openModal();

        } else if (state.tool === 'marker') {

            state.markerPos = pos;

            openMarkerModal();

        }

    }



    function moveAction(e) {

        if (state.chartDragging) {

            const pos = getMousePos(e);

            state.chartPos.x = pos.x - state.chartDragStart.x;

            state.chartPos.y = pos.y - state.chartDragStart.y;

            redrawWithChart();

            return;

        }



        if (!state.isDrawing) return;

        const pos = getMousePos(e);



        if (state.tool === 'brush' || state.tool === 'eraser') {

            ctx.beginPath();

            ctx.moveTo(state.lastX, state.lastY);

            ctx.lineTo(pos.x, pos.y);

            ctx.strokeStyle = (state.tool === 'eraser') ? '#ffffff' : state.color;

            ctx.lineWidth = state.size;

            ctx.lineCap = 'round';

            ctx.lineJoin = 'round';

            ctx.stroke();

        }



        state.lastX = pos.x;

        state.lastY = pos.y;

    }



    function endAction() {

        if (state.chartDragging) {

            container.classList.remove('dragging');

            state.chartDragging = false;

            saveState();

            return;

        }



        if (state.isDrawing) saveState();

        state.isDrawing = false;

    }



    function isMouseOverChart(pos) {

        const chartWidth = 700;

        const chartHeight = 500;

        return pos.x >= state.chartPos.x && 

               pos.x <= state.chartPos.x + chartWidth &&

               pos.y >= state.chartPos.y && 

               pos.y <= state.chartPos.y + chartHeight;

    }



    function drawPOI(x, y) {

        ctx.fillStyle = state.color;

        ctx.font = `${state.size * 1.5}px "Inter", sans-serif`;

        ctx.textAlign = 'center';

        ctx.textBaseline = 'middle';

        ctx.fillText(state.currentSymbol, x, y);

    }



    // –§–£–ù–ö–¶–ò–ò –ì–†–ê–§–ò–ö–ê

    function refreshChartUI() {

        const container = document.getElementById('chartSections');

        container.innerHTML = '';



        state.chartData.forEach((item, index) => {

            const div = document.createElement('div');

            div.className = 'chart-section-item';

            div.innerHTML = `

                <input type="text" value="${item.label}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" 

                    onchange="state.chartData[${index}].label=this.value" style="font-weight:600;">

                <input type="number" value="${item.value}" min="1" max="500" 

                    onchange="state.chartData[${index}].value=parseInt(this.value)">

                <button class="chart-btn-small" onclick="changeValue(${index}, 5)">+5</button>

                <button class="chart-btn-small chart-btn-remove" onclick="removeChartSection(${index})">‚úï</button>

            `;

            container.appendChild(div);

        });

    }



    function addChartSection() {

        const newColor = CHART_COLORS[state.chartData.length % CHART_COLORS.length];

        state.chartData.push({ 

            label: `–†–∞–∑–¥–µ–ª ${state.chartData.length + 1}`, 

            value: 50,

            color: newColor

        });

        refreshChartUI();

    }



    function removeChartSection(index) {

        state.chartData.splice(index, 1);

        refreshChartUI();

    }



    function changeValue(index, amount) {

        state.chartData[index].value = Math.max(1, state.chartData[index].value + amount);

        refreshChartUI();

    }



    function drawChartToCanvas() {

        state.chartVisible = true;

        state.baseCanvasData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        redrawWithChart();

        saveState();

        togglePanel(false);

    }



    function redrawWithChart() {

        if (!state.baseCanvasData) return;

        

        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞–∑–æ–≤—ã–π —Ö–æ–ª—Å—Ç

        ctx.putImageData(state.baseCanvasData, 0, 0);



        const chartType = state.chartType;

        const startX = state.chartPos.x;

        const startY = state.chartPos.y;

        const width = 700;

        const height = 500;



        // –§–æ–Ω –≥—Ä–∞—Ñ–∏–∫–∞

        ctx.fillStyle = 'rgba(255,255,255,0.98)';

        ctx.strokeStyle = '#333';

        ctx.lineWidth = 2;

        ctx.fillRect(startX, startY, width, height);

        ctx.strokeRect(startX, startY, width, height);



        // –ó–∞–≥–æ–ª–æ–≤–æ–∫

        ctx.fillStyle = '#000';

        ctx.font = 'bold 28px sans-serif';

        ctx.textAlign = 'left';

        ctx.fillText('–ì–†–ê–§–ò–ö', startX + 20, startY + 40);



        if(chartType === 'line') {

            drawLineChart(startX, startY, width, height);

        } else if(chartType === 'bar') {

            drawBarChart(startX, startY, width, height);

        } else if(chartType === 'pie') {

            drawPieChart(startX, startY, width, height);

        }



        // –õ–µ–≥–µ–Ω–¥–∞

        drawChartLegend(startX + width + 20, startY);



        // –ú–∞—Ä–∫–µ—Ä—ã

        redrawMarkers();

    }



    function drawLineChart(startX, startY, width, height) {

        const data = state.chartData;

        const maxValue = Math.max(...data.map(d => d.value));

        const graphWidth = width - 120;

        const graphHeight = height - 120;

        const pointSpacing = graphWidth / (data.length - 1 || 1);

        const graphLeft = startX + 60;

        const graphTop = startY + 70;

        const graphBottom = graphTop + graphHeight;



        ctx.strokeStyle = '#333';

        ctx.lineWidth = 2;

        ctx.beginPath();

        ctx.moveTo(graphLeft, graphBottom);

        ctx.lineTo(graphLeft + graphWidth, graphBottom);

        ctx.moveTo(graphLeft, graphTop);

        ctx.lineTo(graphLeft, graphBottom);

        ctx.stroke();



        drawArrow(ctx, graphLeft + graphWidth, graphBottom, graphLeft + graphWidth + 15, graphBottom);

        drawArrow(ctx, graphLeft, graphTop, graphLeft, graphTop - 15);



        ctx.strokeStyle = '#3b82f6';

        ctx.lineWidth = 3;

        ctx.beginPath();



        data.forEach((item, i) => {

            const x = graphLeft + i * pointSpacing;

            const y = graphBottom - (item.value / maxValue) * graphHeight;



            if(i === 0) ctx.moveTo(x, y);

            else ctx.lineTo(x, y);



            ctx.fillStyle = item.color;

            ctx.fillRect(x - 5, y - 5, 10, 10);



            ctx.fillStyle = '#000';

            ctx.font = 'bold 14px sans-serif';

            ctx.textAlign = 'center';

            ctx.fillText(item.value, x, y - 20);



            ctx.font = '12px sans-serif';

            ctx.fillText(item.label, x, graphBottom + 25);

        });



        ctx.stroke();

    }



    function drawBarChart(startX, startY, width, height) {

        const data = state.chartData;

        const maxValue = Math.max(...data.map(d => d.value));

        const graphWidth = width - 120;

        const graphHeight = height - 120;

        const barWidth = graphWidth / (data.length * 1.5);

        const graphLeft = startX + 60;

        const graphTop = startY + 70;

        const graphBottom = graphTop + graphHeight;



        ctx.strokeStyle = '#333';

        ctx.lineWidth = 2;

        ctx.beginPath();

        ctx.moveTo(graphLeft, graphBottom);

        ctx.lineTo(graphLeft + graphWidth, graphBottom);

        ctx.moveTo(graphLeft, graphTop);

        ctx.lineTo(graphLeft, graphBottom);

        ctx.stroke();



        drawArrow(ctx, graphLeft + graphWidth, graphBottom, graphLeft + graphWidth + 15, graphBottom);

        drawArrow(ctx, graphLeft, graphTop, graphLeft, graphTop - 15);



        data.forEach((item, i) => {

            const x = graphLeft + (i + 0.5) * (graphWidth / data.length);

            const barHeight = (item.value / maxValue) * graphHeight;

            const y = graphBottom - barHeight;



            ctx.fillStyle = item.color;

            ctx.fillRect(x - barWidth/2, y, barWidth, barHeight);

            ctx.strokeStyle = '#333';

            ctx.lineWidth = 1;

            ctx.strokeRect(x - barWidth/2, y, barWidth, barHeight);



            ctx.fillStyle = '#000';

            ctx.font = 'bold 14px sans-serif';

            ctx.textAlign = 'center';

            ctx.fillText(item.value, x, y - 10);



            ctx.font = '12px sans-serif';

            ctx.fillText(item.label, x, graphBottom + 25);

        });

    }



    function drawPieChart(startX, startY, width, height) {

        const data = state.chartData;

        const total = data.reduce((a, b) => a + b.value, 0);

        const centerX = startX + width / 2 + 60;

        const centerY = startY + height / 2 + 40;

        const radius = Math.min(width, height) / 3 - 40;



        let startAngle = -Math.PI / 2;



        data.forEach((item, i) => {

            const sliceAngle = (item.value / total) * 2 * Math.PI;

            const endAngle = startAngle + sliceAngle;

            const midAngle = startAngle + sliceAngle / 2;



            ctx.fillStyle = item.color;

            ctx.beginPath();

            ctx.moveTo(centerX, centerY);

            ctx.arc(centerX, centerY, radius, startAngle, endAngle);

            ctx.closePath();

            ctx.fill();



            ctx.strokeStyle = '#fff';

            ctx.lineWidth = 2;

            ctx.stroke();



            const textRadius = radius * 0.65;

            const textX = centerX + Math.cos(midAngle) * textRadius;

            const textY = centerY + Math.sin(midAngle) * textRadius;



            ctx.fillStyle = '#fff';

            ctx.font = 'bold 14px sans-serif';

            ctx.textAlign = 'center';

            ctx.textBaseline = 'middle';

            const percent = ((item.value / total) * 100).toFixed(0);

            ctx.fillText(percent + '%', textX, textY);



            startAngle = endAngle;

        });

    }



    function drawChartLegend(x, y) {

        ctx.fillStyle = 'rgba(0,0,0,0.05)';

        ctx.fillRect(x - 10, y, 150, state.chartData.length * 30 + 20);



        ctx.fillStyle = '#000';

        ctx.font = 'bold 14px sans-serif';

        ctx.textAlign = 'left';

        ctx.fillText('–õ–ï–ì–ï–ù–î–ê:', x, y + 25);



        state.chartData.forEach((item, i) => {

            const itemY = y + 50 + i * 30;



            ctx.fillStyle = item.color;

            ctx.fillRect(x, itemY - 12, 16, 16);



            ctx.fillStyle = '#000';

            ctx.font = '12px sans-serif';

            ctx.fillText(item.label + ' (' + item.value + ')', x + 25, itemY);

        });

    }



    function drawArrow(ctx, fromx, fromy, tox, toy) {

        const headlen = 12;

        const angle = Math.atan2(toy - fromy, tox - fromx);

        ctx.fillStyle = '#333';

        ctx.beginPath();

        ctx.moveTo(tox, toy);

        ctx.lineTo(tox - headlen * Math.cos(angle - Math.PI / 6), toy - headlen * Math.sin(angle - Math.PI / 6));

        ctx.lineTo(tox - headlen * Math.cos(angle + Math.PI / 6), toy - headlen * Math.sin(angle + Math.PI / 6));

        ctx.closePath();

        ctx.fill();

    }



    // –§–£–ù–ö–¶–ò–ò –ú–ê–†–ö–ï–†–û–í

    function redrawMarkers() {

        state.markers.forEach(marker => {

            ctx.fillStyle = marker.color;

            ctx.beginPath();

            ctx.arc(marker.x, marker.y, 8, 0, Math.PI * 2);

            ctx.fill();

            

            ctx.strokeStyle = '#ffffff';

            ctx.lineWidth = 2;

            ctx.stroke();



            ctx.fillStyle = '#000';

            ctx.font = 'bold 14px sans-serif';

            ctx.textAlign = 'center';

            ctx.textBaseline = 'bottom';

            ctx.fillText(marker.label, marker.x, marker.y - 20);

        });

    }



    function openMarkerModal() { 

        document.getElementById('markerModal').classList.add('active');

        document.getElementById('markerInput').focus();

    }

    function closeMarkerModal() { 

        document.getElementById('markerModal').classList.remove('active'); 

    }



    function confirmMarker() {

        const txt = document.getElementById('markerInput').value;

        if (txt && state.markerPos) {

            state.markers.push({

                x: state.markerPos.x,

                y: state.markerPos.y,

                label: txt,

                color: state.markerColor

            });

            if(state.chartVisible) {

                redrawWithChart();

            } else {

                redrawMarkers();

            }

            saveState();

        }

        document.getElementById('markerInput').value = '';

        closeMarkerModal();

    }



    // –ò–ú–ü–û–†–¢ –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–Ø

    imageInput.addEventListener('change', (e) => {

        const file = e.target.files[0];

        if(!file) return;



        const reader = new FileReader();

        reader.onload = (event) => {

            const img = new Image();

            img.onload = () => {

                const scale = Math.min(canvas.width / img.width, canvas.height / img.height);

                const x = (canvas.width - img.width * scale) / 2;

                const y = (canvas.height - img.height * scale) / 2;



                ctx.drawImage(img, x, y, img.width * scale, img.height * scale);

                saveState();

                setTool('brush', document.querySelector('.tool-card'));

            };

            img.src = event.target.result;

        };

        reader.readAsDataURL(file);

        imageInput.value = '';

    });



    // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò

    function fitCanvas() {

        const wrapper = document.querySelector('.viewport');

        const baseScale = Math.min(

            (wrapper.clientWidth - 40) / canvas.width,

            (wrapper.clientHeight - 40) / canvas.height

        );

        const finalScale = baseScale * state.zoomLevel;

        container.style.transform = `scale(${finalScale})`;

    }



    function togglePanel(force) {

        const panel = document.getElementById('sidePanel');

        if (force === true) panel.classList.add('active');

        else if (force === false) panel.classList.remove('active');

        else panel.classList.toggle('active');

    }



    function openModal() { document.getElementById('textModal').classList.add('active'); }

    function closeModal() { document.getElementById('textModal').classList.remove('active'); }



    function confirmText() {

        const txt = document.getElementById('mapTextInput').value;

        if (txt) {

            ctx.fillStyle = state.color;

            ctx.font = `bold ${state.size}px sans-serif`;

            ctx.textAlign = 'left';

            ctx.fillText(txt, state.textPos.x, state.textPos.y);

            saveState();

        }

        document.getElementById('mapTextInput').value = '';

        closeModal();

    }



    function saveState() {

        if (state.history.length > 30) state.history.shift();

        state.history.push(canvas.toDataURL());

        state.redoStack = [];

    }



    function undo() {

        if (state.history.length < 2) return;

        state.redoStack.push(state.history.pop());

        const img = new Image();

        img.src = state.history[state.history.length - 1];

        img.onload = () => {

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.drawImage(img, 0, 0);

        };

    }



    function redo() {

        if (state.redoStack.length === 0) return;

        const data = state.redoStack.pop();

        state.history.push(data);

        const img = new Image();

        img.src = data;

        img.onload = () => {

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            ctx.drawImage(img, 0, 0);

        };

    }



    function exportCanvas() {

        const link = document.createElement('a');

        link.download = 'my-map-' + new Date().getFullYear() + '.png';

        link.href = canvas.toDataURL('image/png');

        link.click();

    }



    // –§–£–ù–ö–¶–ò–ò –ó–£–ú–ê

    function zoomIn() {

        state.zoomLevel = Math.min(state.maxZoom, state.zoomLevel + 0.2);

        applyZoom();

    }



    function zoomOut() {

        state.zoomLevel = Math.max(state.minZoom, state.zoomLevel - 0.2);

        applyZoom();

    }



    function zoomReset() {

        state.zoomLevel = 1.0;

        applyZoom();

    }



    function applyZoom() {

        const wrapper = document.querySelector('.viewport');

        const baseScale = Math.min(

            (wrapper.clientWidth - 40) / canvas.width,

            (wrapper.clientHeight - 40) / canvas.height

        );

        

        const finalScale = baseScale * state.zoomLevel;

        container.style.transform = `scale(${finalScale})`;

    }



    window.onload = init;

</script>

</body>

</html>
